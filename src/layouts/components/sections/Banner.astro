---
import type { z } from "astro/zod";
import type { Section } from "@/types";
import { getEntryCTM } from "@/lib/customContentLoader.astro";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import { markdownify } from "@/lib/utils/textConverter";
import type { bannerAgencySectionSchema } from "@/sections.schema";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";
import { getLocaleUrlCTM } from "@/lib/utils/i18nUtils";
import ReactIcons from "@/layouts/helpers/ReactIcons.astro";

type bannerAgency = Section &
  NonNullable<z.infer<typeof bannerAgencySectionSchema>>;

type SocialLink = {
  label: string;
  icon: string;
  url: string;
};

type HighlightProject = {
  tag?: string;
  title: string;
  subtitle?: string;
  url?: string;
};

type ButtonConfig = {
  enable?: boolean;
  label?: string;
  url?: string;
};

type ExtendedBanner = bannerAgency & {
  socialLinks?: SocialLink[];
  highlightProject?: HighlightProject;
  videoUrl?: string;
  button?: ButtonConfig;
  ctaTitle?: string;
  ctaDescription?: string;
  watchEyebrow?: string;
  watchTitle?: string;
};

type Props = {
  content?: bannerAgency;
};

const defaultContent = (
  await getEntryCTM("sections", "banner", Astro.currentLocale)
)?.data as bannerAgency;

const actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as ExtendedBanner;

const {
  title,
  description,
  image,
  badge,
  socialLinks,
  highlightProject,
  videoUrl,
  button,
  ctaTitle,
  ctaDescription,
  watchEyebrow,
  watchTitle,
} = actualContent;

const resolvedTitle = Array.isArray(title)
  ? title.filter(Boolean).join(" ")
  : title;

const fallbackSocials: SocialLink[] = [
  { label: "Dribbble", icon: "FaDribbble", url: "#" },
  { label: "Behance", icon: "FaBehance", url: "#" },
  { label: "LinkedIn", icon: "FaLinkedinIn", url: "#" },
];

const safeSocialLinks =
  socialLinks?.length && socialLinks.every((entry) => entry?.icon && entry.url)
    ? socialLinks
    : fallbackSocials;

const heroImage = image || "/images/portfolio/1.jpg";

const heroProject: HighlightProject = {
  tag: "Recently Launched",
  title: "Branding Design",
  subtitle: "Particle AI",
  url: "#",
  ...highlightProject,
};

const watchUrl = videoUrl?.startsWith("http")
  ? videoUrl
  : getLocaleUrlCTM(videoUrl || "https://www.youtube.com/watch?v=go7QYaQR494", Astro.currentLocale);

const projectUrl = heroProject.url
  ? heroProject.url.startsWith("http")
    ? heroProject.url
    : getLocaleUrlCTM(heroProject.url, Astro.currentLocale)
  : "#";

const badgeLabel = badge?.label || "Global AI Agency";
const primaryCtaEnabled = button?.enable !== false;
const primaryCtaLabel = button?.label || "Start for Your Business";
const primaryCtaUrl = button?.url
  ? button.url.startsWith("http")
    ? button.url
    : getLocaleUrlCTM(button.url, Astro.currentLocale)
  : "#";
const resolvedCtaTitle =
  ctaTitle || "ATYLUS engines are ready to deploy autonomous AI systems for you.";
const resolvedCtaDescription =
  ctaDescription ||
  "Join now and transform operations with self-optimizing, data-native intelligence.";
const resolvedWatchEyebrow = watchEyebrow || "Watch Intro";
const resolvedWatchTitle = watchTitle || "AI-First Digital Transformation";

---

<section class="banner-hero relative isolate">
  <div
    class="absolute top-0 right-0 h-[600px] w-[600px] -translate-y-1/4 translate-x-1/3 rounded-full bg-accent/10 blur-[150px] opacity-80"
    aria-hidden="true"></div>
  <div
    class="absolute bottom-0 left-0 h-[400px] w-[400px] translate-y-1/4 -translate-x-1/3 rounded-full bg-accent-blue/10 blur-[120px]"
    aria-hidden="true"></div>

  <div class="container relative z-10 mx-auto px-6 pb-12 pt-12 md:pb-20 md:pt-20 lg:px-12">
    <div class="flex flex-col gap-12 lg:flex-row lg:gap-20">
      <aside
        class="reveal-on-scroll hidden w-12 shrink-0 flex-col items-center gap-8 pt-12 text-[#fffafa]/50 lg:flex"
        style="animation-delay:0.1s;">
        <span class="text-xs font-medium uppercase tracking-[0.35em] [writing-mode:vertical-rl]">
          Follow Us
        </span>
        <span class="block h-16 w-px bg-linear-to-b from-accent to-transparent"></span>
        <div class="flex flex-col gap-6 text-lg text-[#fffafa]/50">
          {safeSocialLinks.map((social) => (
            <a
              href={social.url}
              aria-label={social.label}
              class="transition-colors duration-300 hover:text-accent">
              <ReactIcons icon={social.icon} />
            </a>
          ))}
        </div>
      </aside>

      <div class="flex-1 space-y-16">
        <div class="reveal-on-scroll space-y-6" style="animation-delay:0.2s;">
          {badge?.enable !== false && (
            <div class="inline-flex items-center gap-2 rounded-full border border-[#fffafa]/10 bg-[#fffafa]/5 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-[#fffafa]/80">
              <span class="h-2 w-2 animate-pulse rounded-full bg-accent"></span>
              <span>{badgeLabel}</span>
            </div>
          )}

          {resolvedTitle && (
            <h1
              class="text-5xl font-bold leading-[1.05] tracking-tight text-[#fffafa] md:text-7xl xl:text-[90px]"
              set:html={markdownify(
                resolvedTitle ||
                  "We’re <br /> <span class=\"text-transparent bg-clip-text bg-linear-to-r from-[#fffafa] via-[#fffafa] to-[#fffafa]/40\">Creative Design</span><br /> & Development.",
              )}>
            </h1>
          )}

          <div class="grid gap-10 md:grid-cols-12 md:items-start">
            <div class="md:col-span-5 lg:col-span-4">
              <div class="mb-4 flex flex-col gap-4">
                {resolvedCtaTitle && (
                  <h3
                    class="text-lg font-semibold text-[#fffafa]"
                    set:html={markdownify(resolvedCtaTitle)}
                  />
                )}
                {resolvedCtaDescription && (
                  <p
                    class="text-base text-[#fffafa]/75"
                    set:html={markdownify(resolvedCtaDescription)}
                  />
                )}
                {primaryCtaEnabled && (
                  <a
                    href={primaryCtaUrl}
                    class="inline-block mt-2 rounded-lg bg-accent px-6 py-3 font-medium text-[#0d0101] transition-all duration-300 hover:bg-[#ff5d00]/90"
                  >
                    {primaryCtaLabel}
                  </a>
                )}
              </div>
            </div>

            <div class="md:col-span-7 lg:col-span-8 md:border-l md:border-[#fffafa]/10 md:pl-8">
              {description && (
                <p
                  class="mb-8 text-xl font-light leading-relaxed text-[#fffafa]/70"
                  set:html={markdownify(description)}
                />
              )}
              <div class="flex items-center gap-6">
                <a
                  href={watchUrl}
                  target={watchUrl.startsWith("http") ? "_blank" : undefined}
                  rel={watchUrl.startsWith("http") ? "noopener noreferrer" : undefined}
                  class="group relative flex h-16 w-16 items-center justify-center rounded-full border border-[#fffafa]/10 bg-[#fffafa]/5 transition-all duration-300 hover:scale-105 hover:border-accent hover:bg-accent">
                  <span class="text-lg text-[#fffafa] transition-transform duration-300 group-hover:scale-110">
                    ▶
                  </span>
                  <span class="absolute inset-0 rounded-full border border-[#fffafa]/20 transition-all duration-700 group-hover:scale-150 group-hover:opacity-0"></span>
                </a>
                <div>
                  <p class="text-sm font-medium uppercase tracking-[0.3em] text-[#fffafa]/50">
                    {resolvedWatchEyebrow}
                  </p>
                  <p class="text-lg font-semibold text-[#fffafa]">
                    {resolvedWatchTitle}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="reveal-on-scroll" style="animation-delay:0.4s;">
          <div class="relative h-[500px] w-full overflow-hidden rounded-[40px] md:h-[600px]">
            <OptimizedImage
              src={heroImage}
              alt={resolvedTitle || "Banner visual"}
              class="absolute inset-0 h-full w-full object-cover transition-transform duration-1200 hover:scale-105"
            />
            <div class="absolute inset-0 bg-linear-to-t from-[#0d0101]/80 via-transparent"></div>

            <div class="absolute top-8 right-8 hidden md:block">
              <svg
                width="120"
                height="120"
                viewBox="0 0 100 100"
                class="animate-spin-slow opacity-80">
                <path d="M0,50 a50,50 0 1,1 100,0 a50,50 0 1,1 -100,0" fill="none" id="banner-circle"></path>
                <text fill="#fffafa" font-size="10" font-weight="bold" letter-spacing="4">
                  <textPath href="#banner-circle">
                    CREATIVE • AESTHETICS • DESIGN •
                  </textPath>
                </text>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-xl text-accent">★</span>
              </div>
            </div>

            <div class="absolute bottom-6 right-6 left-6 md:bottom-12 md:right-12 md:left-auto md:w-96">
              <div class="glass-panel relative overflow-hidden rounded-4xl p-6">
                <div class="absolute -right-10 -bottom-10 h-32 w-32 rounded-full bg-accent/40 blur-2xl transition-all duration-500"></div>
                <div class="relative z-10 flex items-end justify-between gap-4">
                  <div>
                    <span class="text-sm font-medium text-[#fffafa]/60">
                      {heroProject.tag}
                    </span>
                    <h3 class="text-2xl font-bold leading-tight text-[#fffafa]">
                      {heroProject.title}
                      <br />
                      {heroProject.subtitle}
                    </h3>
                  </div>
                  <a
                    href={projectUrl}
                    class="flex h-12 w-12 items-center justify-center rounded-full bg-[#fffafa] text-[#0d0101] transition-colors duration-300 hover:bg-accent hover:text-[#fffafa]">
                    <ReactIcons icon="FaArrowRight" class="-rotate-45" />
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="reveal-on-scroll hidden w-12 pt-40 lg:block" style="animation-delay:0.5s;">
        <div class="relative h-full border-l border-dashed border-[#fffafa]/15">
          <span class="absolute -left-1.5 top-0 block h-3 w-3 rounded-full bg-accent"></span>
        </div>
      </div>
    </div>
  </div>
</section>

<style is:inline>
  .banner-hero {
    background:
      radial-gradient(circle at 20% 20%, rgba(255, 93, 0, 0.08), transparent 45%),
      radial-gradient(circle at 80% 0%, rgba(46, 152, 255, 0.08), transparent 55%),
      linear-gradient(180deg, #160202 0%, #0f0101 45%, #0d0101 70%, #0d0101 100%);
    color: #fffafa;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    overflow: hidden;
  }

  .glass-panel {
    background: rgba(28, 28, 30, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .reveal-on-scroll {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1),
      transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .reveal-on-scroll.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  @keyframes banner-slide-up {
    from {
      opacity: 0;
      transform: translateY(40px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-spin-slow {
    animation: spin-slow 12s linear infinite;
  }

  @keyframes spin-slow {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  :global(::selection) {
    background: #ff5d00;
    color: #fffafa;
  }
</style>

<script is:inline>
  (() => {
    if (typeof window === "undefined") return;

    const revealElements = document.querySelectorAll(".reveal-on-scroll");

    if (!revealElements.length) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-visible");
          }
        });
      },
      { threshold: 0.15 },
    );

    revealElements.forEach((el) => observer.observe(el));
  })();
</script>
